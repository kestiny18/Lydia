# Lydia Architecture Overview

## Architecture Overview

```
??????????????????????????????????????????????????????????????????????                       User Access Layer                        ???? ???????????????? ???????????????? ????????????????             ???? ?? CLI Client ?? ??  Web API   ?? ?? SDK Integ. ??             ???? ???????????????? ???????????????? ????????????????             ??????????????????????????????????????????????????????????????????????          ??               ??               ??          ??               ??               ????????????????????????????????????????????????????????????????????????                       Core Engine Layer                        ???? ????????????????????????????????????????????????????????????   ???? ??                   Agent Runtime                        ??   ???? ?? ?????????????? ?????????????? ??????????????           ??   ???? ?? ??Task Mgr  ?? ??Session Mgr?? ??Context Mgr??           ??   ???? ?? ?????????????? ?????????????? ??????????????           ??   ???? ????????????????????????????????????????????????????????????   ????                             ??                                 ????                             ??                                 ???? ????????????????????????????????????????????????????????????   ???? ??                Strategy Engine (Core)                  ??   ???? ?? ?????????????? ?????????????? ??????????????           ??   ???? ?? ??Intent    ?? ??Planner   ?? ??Decision  ??           ??   ???? ?? ?????????????? ?????????????? ??????????????           ??   ???? ?? ?????????????? ?????????????? ??????????????           ??   ???? ?? ??Evaluator ?? ??Reflection?? ??Recovery  ??           ??   ???? ?? ?????????????? ?????????????? ??????????????           ??   ???? ????????????????????????????????????????????????????????????   ??????????????????????????????????????????????????????????????????????                               ??                               ????????????????????????????????????????????????????????????????????????                       Capability Layer                         ???? ?????????????????????????????????????????????????????????????? ???? ??                 Capability Abstraction                   ?? ???? ?? ???????????????????????????? ?????????????????????????????? ???? ?? ??     Skill System       ?? ??     MCP Tools          ???? ???? ?? ??  (Knowledge Injection) ?? ??   (Tool Execution)     ???? ???? ?? ???????????????????????????? ?????????????????????????????? ???? ?????????????????????????????????????????????????????????????? ???? ?????????????? ?????????????? ??????????????                   ???? ??LLM Abstr.?? ??Memory Sys?? ??Knowledge ??                   ???? ?????????????? ?????????????? ??????????????                   ??????????????????????????????????????????????????????????????????????                               ??                               ????????????????????????????????????????????????????????????????????????                    Infrastructure Layer                        ???? ?????????????? ?????????????? ?????????????? ??????????????   ???? ??Storage   ?? ??Logging   ?? ??Config    ?? ??Plugins   ??   ???? ?????????????? ?????????????? ?????????????? ??????????????   ??????????????????????????????????????????????????????????????????????```

---

## Technology Stack

| Component | Choice | Rationale |
|-----------|--------|-----------|
| **Language** | TypeScript | Type safety, rich ecosystem, unified frontend/backend |
| **Runtime** | Node.js | Mature, stable, async-friendly, cross-platform |
| **CLI Framework** | Commander + Inquirer | Lightweight, flexible, interactive |
| **Web Framework** | Hono | Lightweight, fast, TypeScript friendly |
| **LLM Integration** | Custom Abstraction | Support multi-model switching, unified interface |
| **Tool Execution** | MCP (Model Context Protocol) | Industry standard, rich ecosystem |
| **Knowledge** | Skill System | Lightweight config, user extensible |
| **Storage** | JSON + SQLite | Local-first, lightweight, no external deps |
| **Testing** | Vitest | Fast, native TypeScript support |

---

## Four-Layer Architecture Detail

### Layer 1: User Access Layer

Responsible for user interaction, providing multiple access methods:

| Access Method | Description | Priority |
|---------------|-------------|----------|
| **CLI** | Command line interaction, developer's choice | P0 |
| **Web API** | RESTful + WebSocket, remote access | P1 |
| **SDK** | Embedded in other apps as a library | P2 |

### Layer 2: Core Engine Layer

The brain of the system, containing two core components:

#### Agent Runtime
- **Task Manager**: Manages task lifecycle (create ??execute ??complete/fail)
- **Session Manager**: Maintains conversation context and history
- **Context Manager**: Manages current execution environment and state

#### Strategy Engine (The Core)
- **Intent Understanding**: Analyzes user input to identify real needs
- **Task Planning**: Decomposes complex tasks into executable steps
- **Execution Decision**: Selects optimal execution paths and tools
- **Strategy Evaluation**: Assesses the effectiveness of current strategies
- **Reflection Mechanism**: Summarizes lessons learned after execution
- **Error Recovery**: Handles failures and attempts alternative solutions

### Layer 3: Capability Layer

Provides specific execution capabilities:

| Module | Responsibility |
|--------|----------------|
| **LLM Abstraction** | Unified interface for calling different LLMs |
| **Tool System** | Manages and calls external tools/APIs |
| **Memory System** | Short-term + Long-term memory management |
| **Knowledge Base** | Stores and retrieves domain knowledge |

### Layer 4: Infrastructure Layer

Underlying support services:

| Module | Responsibility |
|--------|----------------|
| **File Storage** | Local data persistence |
| **Logging System** | Records execution process, supports debugging |
| **Config Management** | Manages system and user configurations |
| **Plugin System** | Supports third-party extensions |

---

## Data Flow

### Typical Request Processing Flow

```
User Input
    ??    ????????????????????????1. Access Layer  ????Parse command/request
????????????????????         ??         ????????????????????????2. Intent Analysis????Call LLM to analyze intent
????????????????????         ??         ????????????????????????3. Task Planning  ????Break down into subtasks
????????????????????         ??         ????????????????????????4. Exec Decision  ????Select tools and strategy
????????????????????         ??         ????????????????????????????????????????????5. Execution Loop                    ????   ?????????????????????????????????????   ??Execute Step ??Observe ??Eval ??????   ??    ??                  ??   ??????   ??    ??????????????????????   ??????   ???????????????????????????????????????????????????????????????????????????         ??         ????????????????????????6. Result Aggreg. ????Summarize results
????????????????????         ??         ????????????????????????7. Reflection     ????Record experience
????????????????????         ??         ??    Return to User
```

---

## Directory Structure

```
lydia/
??? docs/                    # Documentation
??? packages/                # Core Packages (Monorepo)
??  ??? core/               # Core Engine
??  ??  ??? src/
??  ??  ??  ??? agent/      # Agent Runtime
??  ??  ??  ??? strategy/   # Strategy Engine
??  ??  ??  ??? llm/        # LLM Abstraction
??  ??  ??  ??? skills/     # Skill System (types, parser, loader, registry, watcher)
??  ??  ??  ??? tools/      # Tool System
??  ??  ??  ??? memory/     # Memory System
??  ??  ??  ??? utils/      # Utilities
??  ??  ??? package.json
??  ??? cli/                # CLI Client
??  ??  ??? src/
??  ??  ??? package.json
??  ??? server/             # Web Service
??  ??  ??? src/
??  ??  ??? package.json
??  ??? shared/             # Shared Types & Tools
??      ??? src/
??      ??? package.json
??? plugins/                 # Official Plugins
??? examples/                # Example Code
??? tests/                   # Integration Tests
??? scripts/                 # Build Scripts
??? package.json             # Root Config
??? pnpm-workspace.yaml      # Monorepo Config
??? tsconfig.json            # TypeScript Config
```

---

## Key Design Decisions

### ADR-001: Adopt Monorepo Structure

**Decision**: Use pnpm workspace to manage multiple packages.

**Reasoning**:
- Core, CLI, Server can be published independently.
- Shared code is easy to reuse.
- Unified version management.

### ADR-002: Strategy Engine Independent of LLM

**Decision**: Separate strategy logic from LLM calls.

**Reasoning**:
- Easier to test (can mock LLM).
- Supports switching different LLMs.
- Strategy logic can be optimized independently.

### ADR-003: Local-First Storage

**Decision**: Default to local file storage.

**Reasoning**:
- Zero-config startup.
- Controllable data privacy.
- Offline availability.

---

## Evolution Loop (Closed-Loop Learning)

The evolution engine should follow a strict, reviewable cycle:
1. Observe: Analyze episodes and traces for patterns.
2. Propose: Generate a strategy update or new skill.
3. Validate: Offline replay against benchmark episodes.
4. Gate: Syntax ?? Tests ?? Safety ?? Human approval.
5. Merge: Apply with cooldown and version tracking.

This loop is the missing link between logs/replay and safe autonomy.

---
## Next Steps

Detailed design documents:
- [Module Design](./modules.md) - Detailed design of each module
- [Data Model](./data-model.md) - Core data structures
- [API Design](./api.md) - External interface definition

---

---

## Agentic Loop (Current Execution Model)

As of v0.2.0, Lydia uses an **LLM-driven agentic loop** instead of the earlier "plan then execute" approach:

```
User Input
    |
    v
Build System Prompt (strategy + skills + memories + constraints)
    |
    v
Get Tool Definitions (MCP tools + DynamicSkill tools)
    |
    v
+---> LLM generate/stream (with tools)
|         |
|         +---[end_turn]---> Done, return response
|         |
|         +---[tool_use]---> Execute tool(s) via MCP or Skill
|                                |
|                                v
|                           Feed tool_result back
|                                |
+--------------------------------+
```

Key properties:
- **Streaming**: `generateStream()` yields `StreamChunk` events for real-time text display
- **Retry**: LLM calls retry with exponential backoff on transient errors (rate limit, 5xx, timeout)
- **Tool Namespace**: Conflicting tool names auto-prefixed with `{serverId}/`
- **Skill Tools**: DynamicSkill tools are registered alongside MCP tools for LLM function calling
- **Multi-turn**: `Agent.chat()` maintains session state across conversation turns
- **Progressive Skill Disclosure**: Only top-K matched skills get content injected; all others appear as a lightweight catalog
- **Hot Reload**: File watcher detects skill file changes and updates the registry without restart

### LLM Provider Interface

All providers implement both `generate()` and `generateStream()`:

```typescript
interface ILLMProvider {
  id: string;
  generate(request: LLMRequest): Promise<LLMResponse>;
  generateStream(request: LLMRequest): AsyncGenerator<StreamChunk, void, unknown>;
}
```

Supported providers: Anthropic, OpenAI, Ollama, Mock, Fallback (cascading).

### Configuration (`config.agent`)

| Option | Default | Description |
|--------|---------|-------------|
| maxIterations | 50 | Safety valve for agentic loop |
| intentAnalysis | false | Optional LLM intent analysis |
| maxRetries | 3 | Retry attempts for LLM calls |
| retryDelayMs | 1000 | Base delay for exponential backoff |
| streaming | true | Enable streaming output |

### Configuration (`config.skills`)

| Option | Default | Description |
|--------|---------|-------------|
| matchTopK | 3 | Max skills with full content in prompt |
| hotReload | true | File watcher for automatic skill reload |
| extraDirs | [] | Additional skill directories to scan |

### Skill System Architecture

The skill system uses a two-phase progressive loading model:

```
Phase 1 (Startup): Scan skill directories
    -> Read ONLY YAML frontmatter (name, description, tags)
    -> Register lightweight SkillMeta into registry
    -> No content bodies in memory

Phase 2 (On-demand): When user sends a request
    -> TF-IDF match(intent, topK=3) against metadata
    -> Lazy-load full content ONLY for matched skills
    -> Inject into prompt:
       Layer 1: Catalog of ALL skills (name + description)
       Layer 2: Full content of top-K matched skills
```

Skill discovery locations (later overrides earlier):
1. Built-in: `packages/core/skills/`
2. User global: `~/.lydia/skills/`
3. Project local: `.lydia/skills/`
4. Extra dirs: from `config.skills.extraDirs`

Hot-reload watches all directories and emits `skill:added`, `skill:updated`, `skill:removed` events.

### Skill Format (SKILL.md)

```yaml
---
name: skill-name
description: What this skill does
version: "1.0.0"          # optional
author: Author Name        # optional
tags: [tag1, tag2]         # optional, used for matching
allowedTools: [tool1]      # optional, restricts available tools
context: main              # optional, 'main' or 'fork'
---

Markdown instructions for the LLM to follow...
```

The schema uses `.passthrough()` so community skills with extra fields (e.g. `license`, `dependencies`) are accepted.

---

**Last Updated**: 2026-02-10

- [Task Execution Chain](./task-execution-chain.md) - End-to-end task flow design
- [Local Installation](./local-installation.md) - One-click local installer design
